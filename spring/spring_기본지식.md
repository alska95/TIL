# spring 기본지식


## 웹 서버, 웹 애플리케이션 서버


### WS
* http 기반으로 동작
* 정적 리소스 제공, 기타 부가기능
* 정적 html, css, js, 이미지, 영상
* ex) NGINX, APACHE
![](https://i.imgur.com/9QQsb20.png)


### WAS
* http 기반으로 동작
* 웹 서버 기능 +a
* 프로그램 코드를 실행해서 어플리케이션 로직 수행
    * 동적 html, html api(json)
    * 서블릿, JSP, 스프링 MVC
    * 예) 톰캣, JETTY, UNDERTOW

![](https://i.imgur.com/X02r8UN.png)


### WAS와 WS차이
* 웹 서버는 정적 리소스(파일), WAS는 애플리케이션 로직
* 둘의 용어도 경계도 모호함.
    * 웹 서버도 프로그램을 실행하는 기능을 포함할 수 있음.
    * 웹 에플리케이션 서버도 웹 서버의 기능을 제공함
* 자바는 서블릿 컨테이너 기능을 제공하면 was
    * 서블릿 없이 자바 코드를 실행하는 서버 프레임워크도 있음.
* WAS는 애플리케이션 코드를 실행하는데 더 특화


### 웹 시스템 구성 - WAS, DB
* WAS가 너무 많은 역할을 담당, 서버 과부하 우려
* 가장 비싼 어플리케이션 로직이 정적 리소스 때문에 수행이 어려울 수 있음
* WAS 장애시 오류 화면도 노출 불가능


### 웹 시스템 구성 - WEB, WAS, DB
* 정적 리소스는 웹 서버가 처리
* 웹 서버는 애플리케이션 로직같은 동적인 처리가 필요하면 WAS에 요청을 위임
* WAS는 중요한 애플리케이션 로직 처리 전담
![](https://i.imgur.com/hvWCR0D.png)



### CDN
* 정적 리소스 캐싱 가능


## 서블릿

![](https://i.imgur.com/qMIG0nD.png)
이 HTTP 메시지를 해석할라면 아래와 같은 과정을 거쳐야한다.

![](https://i.imgur.com/hvz3DUF.png)
***서블릿이 핵심 로직 이외에는 처리해줌***
* urlPatterns와 일치하는 URL이 호출되면 서블릿 코드가 실행됨.
* HTTP 요청 정보를 편리하게 사용할 수 있는 HttpServletRequest
* HTTP 응답 정보를 편리하게 제공할 수 있는 HttpServletResponse
* 개발자는 서블릿을 통해 http스펙을 매우 편리하게 사용 가능하다.

![](https://i.imgur.com/AWyvGvm.png)
1. /hello 요청
2. was서버에서 요청 메시지를 기반으로 request response객체를 새로 만듬.
3. 서블릿 컨테이너의 helloServlet을 실행시킨다.
4. 끝나고 response객체를 바탕으로 응답 메시지를 만든다.
5. 그리고 반환 (hello world)

### 서블릿 컨테이너

서블릿을 지원하는 WAS안에는 서블릿 컨테이너라는 것이 있는데 이 서블릿 컨테이너가 자동으로 서블릿을 생성해주고 호출해준다. 생명 주기도 관리해준다.

* 톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 한다.
* 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기 관리
* 서블릿 객체는 싱글톤으로 관리
    * 요청이 올때마다 객체를 새로 생성하는것은 비효율적이다.
    * 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
    * 모든 요청은 동일한 서블릿 객체 인스턴스에 접근
    * 싱글톤이기 때문에 공유 변수 사용에 주의하여야 한다.
    * 서블릿 컨테이너 종료시 함께 정료된다.
* JSP도 서블릿으로 변환되어 사용된다.
* 동시 요청을 위한 멀티 쓰레드 처리를 지원한다. 
    * 개발자가 크게 신경 안써도 WAS가 처리해주는 부분이 있다.

## 동시 요청 - 멀티 쓰레드

![](https://i.imgur.com/WUMvLOZ.png)

서블릿 호출은 쓰레드를 통해서 이루어진다.

### 쓰레드
* 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드
* 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행
* 쓰레드가 없다면 자바 애플리케이션 실행이 불가능
* 쓰레드는 한번에 하나의 코드 라인만 수행
* 동시 처리가 필요하면 쓰레드를 추가로 생성


### 쓰레드 하나 사용
**단일 요청의 경우**
1. 요청이 들어옴
2. tcp연결후 쓰레드를 할당함
3. 쓰레드를 가지고 서블릿을 호출함
4. 쓰레드 가지고 응답까지하고 쓰레드 휴식 들어감.

**다중 요청의 경우**

![](https://i.imgur.com/p44ZJ3b.png)

이전 쓰레드가 처리 지연 상태이면 다음 요청이 이전 요청이 끝날때까지 대기상태에 있어야 하기 때문에 처리가 끝날때까지 계속 기다리게된다. 그냥 요청이 올때마다 쓰레드를 생성해주면 요청2 계속해서 대기하는 상황을 예방할 수 있다. 다만 쓰레드를 생성하는 비용이 비싸기 때문에 효율적이지 않다.
### 요청마다 쓰레드 생성
* 장점
    * 동시 요청을 처리할 수 있다.
    * 리소스가 허용할 때 까지 처리 가능하다.
    * 하나의 쓰레드가 지연되어도 나머지 쓰레드는 정상 동작한다.
* 단점
    * 쓰레드는 생성 비용이 매우 비싸다
        * 고객 요청이 들어 올 때 마다 쓰레드를 생성하면, 응답 속도가 느려진다.
    * 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
    * 쓰레드 생성에 제한이 없다.
        * 요청이 너무 많이 오면, CPU, 메모리 임계점을 넘어서 서버가 죽을 수 있다.  

### 쓰레드 풀
요청 마다 쓰레드 생성의 단점 보완
* 특징
    * 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
    * 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣은 최대 200개 기본 설정(변경 가능)
* 사용
    * 쓰레드가 필요하면, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.
    * 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다.
    * 최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없다면?
        * 기다리는 요청은 거절하거나 특정 숫자만큼 대기하도록 설정할 수 있다.
* 장점
    * 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용이 절약되고 응답 시간이 빠르다.
    * 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.  

### 쓰레드 풀 - 튜닝
* WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수이다.
* 이 값을 너무 낮게 설정하면?
    * 서버 리소스는 널널하지만, 클라이언트의 처리가 느려질 수 있다.
* 이 값을 너무 높게 설정하면?
    * 동시요청이 서버 리소스를 초과하면 서버가 그대로 다운돼버린다.
* 장애가 발생하면 어떻게할까
    * 클라우드면 일단 서버부터 늘리고, 이후에 튜닝
* 적정 숫자는 성능 테스트를 통해서 찾아보자.
    * nGrinder같은거 사용해서

### 정리
* 멀티 쓰레드 부분은 WAS가 처리함
* 개발자는 멀티 쓰레드 관련 코드는 신경쓰지 않아도 된다.
* 개발자는 싱글 쓰레드 프로그래밍 하듯이 편리하게 소스코드 개발하면됨.
* 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용해야한다.


## 정적 리소스, 동적 html, HTTP API

### 정적 리소스
![](https://i.imgur.com/1KUiNP9.png)

### 동적 html
![](https://i.imgur.com/3DF8TXv.png)

### HTTP API
HTML이 아니라, data를 주고 받는다. 웹 클라이언트, 자바스크립트(ajax 등), 앱 클라이언트, 다른 서버 등등과 json으로 데이터를 주고 받으며 교류 가능하다.
![](https://i.imgur.com/bZbBLBM.png)

### SSR - 서버 사이드 렌더링
서버에서 최종 HTML을 생성해서 클라이언트에 전달 - thymeleaf같은거

### CSR - 클라이언트 사이드 렌더링
리엑트 같은거  

### UI 기술

* 백엔드 - 서버 사이드 렌더링 기술
    * JSP, 타임리프
    * 정적, 복잡하지 않은 화면에 사용
* 프론트 엔드 - 클라이언트 사이드 렌더링 기술
    * React, Vue.js
    * 복잡하고 동적인 UI 사용
    * 웹 프론트 엔드 개발자의 전문 분야



## REST API

### REST 란

* REST의 정의
    * "Representational State Transfer"의 약자
    * 자원의 이름으로 구분하여 해당 자원의 상태를 주고 받는 모든것을 의미한다.
    * REST는 기본적으로 웹의 기존 기술과 HTTP 프로토콜을 그대로 활용하기 때문에 웹의 장점을 최대한 활용할 수 있는 아키텍처 스타일이다.
    * REST는 네트워크 상에서 Client와 Server 사이의 통신 방식 중 하나이다.
* REST의 구체적인 개념
    * HTTP URI를 통해 자원(Resource)을 명시하고 HTTP Method(Post, Get, Put, Delete) 를 통해 해당 자원에 대한 CRUD를 적용하는 것을 의미한다.
* REST의 장단점
    * 장점
        * HTTP 프로토콜의 인프라를 그대로 사용하므로 별도의 인프라 구축이 필요없다.
        * HTTP 표준 프로토콜을 따르는 모든 플랫폼에서 사용 가능하다.
        * Hypermedia API의 기본을 충실히 지키며 번용성을 보장한다.
        * REST API 메시지가 의도하는 바를 명확하게 나타내므로 의도하는 바를 쉽게 파악할 수 있다.
        * 서버와 클라이언트의 역할을 명확하게 분리한다.
    * 단점
        * 표준이 존재하지 않는다.
        * 사용할 수 있는 메소드가 4가지 밖에 없다.
        * 구형 브라우저가 아직 처리하지 못하는 부분이 있다.
            * PUT,DELETE 등

* REST가 필요한 이유
    * 최근 서버 프로그램은 다양한 브라우저와 안드로이드, 아이폰과 같은 모바일 디바이스에서 모두 통신이 가능해야함.
    * 이런한 멀티 플랫폼에 대한 지원을 위해 서비스 자원에 대한 아키텍처를 세우고 이용하는 방법을 모색한 결과, REST에 관심을 가지게 되었다.